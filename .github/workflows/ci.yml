name: Starter CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: âœ… Validate project
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§™â€â™‚ï¸ Setup environment
        uses: ./.github/actions/setup-environment

      - name: ğŸ–ï¸ Check types
        run: pnpm run check:types

      - name: ğŸ“‘ Check lint
        run: pnpm run check:lint

      - name: ğŸ“š Check spelling
        run: pnpm run check:spelling

      - name: ğŸ“¦ Check package.json
        run: pnpm run check:packagejson

      - name: ğŸ“„ Check markdown
        run: pnpm run check:markdown

  test:
    name: ğŸ§ª Test project
    runs-on: ubuntu-latest
    needs: validate

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_DB: starter_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§™â€â™‚ï¸ Setup environment
        uses: ./.github/actions/setup-environment

      - name: ğŸ§ª Run tests
        run: pnpm test:coverage
        env:
          NODE_ENV: test
          DB_CLIENT: pg
          DB_PORT: 5432
          DB_HOST: 127.0.0.1
          DB_USER: postgres
          DB_PASSWORD: secret
          TEST_DB_NAME: starter_test
          TEST_APP_PORT: 8888
          ACCESS_TOKEN_SECRET_KEY: "somerandoma"
          REFRESH_TOKEN_SECRET_KEY: "somerandomr"

  build:
    name: âš’ï¸ Build project
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§™â€â™‚ï¸ Setup environment
        uses: ./.github/actions/setup-environment

      - name: âš’ï¸ Build source code
        run: pnpm build
